import semmle.code.cpp.Comments
import semmle.code.cpp.File
import semmle.code.cpp.Preprocessor

/**
 * Holds if comment `c` indicates that it might be in an auto-generated file, for
 * example because it contains the text "auto-generated by".
 */
private predicate autogeneratedComment(Comment c) {
  // ?s = include newlines in anything (`.`)
  // ?i = ignore case
  c.getContents().regexpMatch("(?si).*(" +

    // auto-generated, automatically generated etc.
    "(auto[\\w-]*\\s*?generated)|" +

    // generated by (at beginning of sentence)
    "([^a-z\\s\\*\\r\\n][\\s\\*\\r\\n]*(generated by)[^a-z])|" +

    // generated file
    "(generated file)|" +

    // file [is] generated
    "(file( is)? generated)|" +

    // changes made in this file will be lost
    "(changes made in this file will be lost)|" +
  
    // do not edit/modify
    "(do(n't|nt| not) (edit|modify))" +

  ").*")
}

/**
 * Holds if the file contains `#line` pragmas that refer to a different file.
 * For example, in `parser.c` a pragma `#line 1 "parser.rl"`.
 * Such pragmas usually indicate that the file was automatically generated.
 */
predicate hasPragmaDifferentFile(File f) {
  exists (PreprocessorLine pl, string s |
    pl.getFile() = f and
    pl.getHead().splitAt(" ", 1) = s and /* Zero index is line number, one index is file reference */
    not ("\"" + f.getAbsolutePath() + "\"" = s) and
    not ("\"" + f.getRelativePath() + "\"" = s) and
    not ("\"" + f.getBaseName() + "\"" = s)
  )
}

/**
 * The maximum line number we consider to be "near the beginning" of file `f`.
 */
private int fileHeaderLimit(File f) {
  result = max(int head, int line |
    head <= 5 and
    locations_default(_, underlyingElement(f), head, _, line, _) |
    line
  ) + 5
}

/**
 * Holds if the file is probably an autogenerated file.
 *
 * A file is probably autogenerated if either of the following heuristics
 * hold:
 *   1. There is a comment in the start of the file that matches
 *      'autogenerated', 'generated by', or a similar phrase.
 *   2. There is a `#line` directive referring to a different file.
 */
class AutogeneratedFile extends File {
  cached AutogeneratedFile() {
    exists(Comment c |
      c.getFile() = this and
      c.getLocation().getStartLine() <= fileHeaderLimit(this) and
      autogeneratedComment(c)
    ) or hasPragmaDifferentFile(this)
  }
}
